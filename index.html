<!DOCTYPE html>
<!-- saved from url=(0152)https://ppl-ai-code-interpreter-files.s3.amazonaws.com/web/direct-files/6182d419025e0f689152773f105591ad/44f8c838-d138-4d3c-a6df-d2cef612ac99/index.html -->
<html lang="it"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Workout Manager</title>
    
    <!-- Supabase SDK v2.x -->
    <script src="./index_files/supabase-js@2"></script>
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);

          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;

          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
          --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
          --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
          --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
          --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
          --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
          --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
          --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;

          /* RGB versions for opacity control */
          --color-success-rgb: 33, 128, 141;
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;

          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
            Monaco, Consolas, monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;

          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;

          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;

          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
            0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
            0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
            inset 0 -1px 0 rgba(0, 0, 0, 0.03);

          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

          /* Layout */
          --container-sm: 640px;
          --container-md: 768px;
          --container-lg: 1024px;
          --container-xl: 1280px;
        }

        @media (prefers-color-scheme: dark) {
          :root {
            /* RGB versions for opacity control (Dark Mode) */
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;

            /* Background color tokens (Dark Mode) */
            --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
            --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
            --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
            --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
            --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
            --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
            --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
            --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

            /* Semantic Color Tokens (Dark Mode) */
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-teal-300);
            --color-primary-hover: var(--color-teal-400);
            --color-primary-active: var(--color-teal-800);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
            --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
            --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400);
            --color-success: var(--color-teal-300);
            --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300);
            --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
            --color-btn-primary-text: var(--color-slate-900);
            --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
              inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

            /* RGB versions for dark mode */
            --color-success-rgb: var(--color-teal-300-rgb);
            --color-error-rgb: var(--color-red-400-rgb);
            --color-warning-rgb: var(--color-orange-400-rgb);
            --color-info-rgb: var(--color-gray-300-rgb);
          }
        }

        /* Base styles */
        html {
          font-size: var(--font-size-base);
          font-family: var(--font-family-base);
          line-height: var(--line-height-normal);
          color: var(--color-text);
          background-color: var(--color-background);
          -webkit-font-smoothing: antialiased;
          box-sizing: border-box;
        }

        body {
          margin: 0;
          padding: 0;
        }

        *,
        *::before,
        *::after {
          box-sizing: inherit;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          margin: 0;
          font-weight: var(--font-weight-semibold);
          line-height: var(--line-height-tight);
          color: var(--color-text);
          letter-spacing: var(--letter-spacing-tight);
        }

        h1 {
          font-size: var(--font-size-4xl);
        }
        h2 {
          font-size: var(--font-size-3xl);
        }
        h3 {
          font-size: var(--font-size-2xl);
        }
        h4 {
          font-size: var(--font-size-xl);
        }
        h5 {
          font-size: var(--font-size-lg);
        }
        h6 {
          font-size: var(--font-size-md);
        }

        p {
          margin: 0 0 var(--space-16) 0;
        }

        a {
          color: var(--color-primary);
          text-decoration: none;
          transition: color var(--duration-fast) var(--ease-standard);
        }

        a:hover {
          color: var(--color-primary-hover);
        }

        /* Buttons */
        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-8) var(--space-16);
          border-radius: var(--radius-base);
          font-size: var(--font-size-base);
          font-weight: 500;
          line-height: 1.5;
          cursor: pointer;
          transition: all var(--duration-normal) var(--ease-standard);
          border: none;
          text-decoration: none;
          position: relative;
        }

        .btn:focus-visible {
          outline: none;
          box-shadow: var(--focus-ring);
        }

        .btn--primary {
          background: var(--color-primary);
          color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
          background: var(--color-primary-hover);
        }

        .btn--primary:active {
          background: var(--color-primary-active);
        }

        .btn--secondary {
          background: var(--color-secondary);
          color: var(--color-text);
        }

        .btn--secondary:hover {
          background: var(--color-secondary-hover);
        }

        .btn--secondary:active {
          background: var(--color-secondary-active);
        }

        .btn--outline {
          background: transparent;
          border: 1px solid var(--color-border);
          color: var(--color-text);
        }

        .btn--outline:hover {
          background: var(--color-secondary);
        }

        .btn--sm {
          padding: var(--space-4) var(--space-12);
          font-size: var(--font-size-sm);
          border-radius: var(--radius-sm);
        }

        .btn--lg {
          padding: var(--space-10) var(--space-20);
          font-size: var(--font-size-lg);
          border-radius: var(--radius-md);
        }

        .btn--full-width {
          width: 100%;
        }

        .btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        /* Form elements */
        .form-control {
          display: block;
          width: 100%;
          padding: var(--space-8) var(--space-12);
          font-size: var(--font-size-md);
          line-height: 1.5;
          color: var(--color-text);
          background-color: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          transition: border-color var(--duration-fast) var(--ease-standard),
            box-shadow var(--duration-fast) var(--ease-standard);
        }

        .form-control:focus {
          border-color: var(--color-primary);
          outline: var(--focus-outline);
        }

        .form-label {
          display: block;
          margin-bottom: var(--space-8);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }

        .form-group {
          margin-bottom: var(--space-16);
        }

        select.form-control {
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right var(--space-12) center;
          background-size: 16px;
          padding-right: var(--space-32);
        }

        /* Card component */
        .card {
          background-color: var(--color-surface);
          border-radius: var(--radius-lg);
          border: 1px solid var(--color-card-border);
          box-shadow: var(--shadow-sm);
          overflow: hidden;
          transition: box-shadow var(--duration-normal) var(--ease-standard);
        }

        .card:hover {
          box-shadow: var(--shadow-md);
        }

        .card__body {
          padding: var(--space-16);
        }

        .card__header,
        .card__footer {
          padding: var(--space-16);
          border-bottom: 1px solid var(--color-card-border-inner);
        }

        /* Status indicators */
        .status {
          display: inline-flex;
          align-items: center;
          padding: var(--space-6) var(--space-12);
          border-radius: var(--radius-full);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }

        .status--success {
          background-color: rgba(
            var(--color-success-rgb, 33, 128, 141),
            var(--status-bg-opacity)
          );
          color: var(--color-success);
          border: 1px solid
            rgba(var(--color-success-rgb, 33, 128, 141), var(--status-border-opacity));
        }

        .status--error {
          background-color: rgba(
            var(--color-error-rgb, 192, 21, 47),
            var(--status-bg-opacity)
          );
          color: var(--color-error);
          border: 1px solid
            rgba(var(--color-error-rgb, 192, 21, 47), var(--status-border-opacity));
        }

        .status--warning {
          background-color: rgba(
            var(--color-warning-rgb, 168, 75, 47),
            var(--status-bg-opacity)
          );
          color: var(--color-warning);
          border: 1px solid
            rgba(var(--color-warning-rgb, 168, 75, 47), var(--status-border-opacity));
        }

        .status--info {
          background-color: rgba(
            var(--color-info-rgb, 98, 108, 113),
            var(--status-bg-opacity)
          );
          color: var(--color-info);
          border: 1px solid
            rgba(var(--color-info-rgb, 98, 108, 113), var(--status-border-opacity));
        }

        /* Container layout */
        .container {
          width: 100%;
          margin-right: auto;
          margin-left: auto;
          padding-right: var(--space-16);
          padding-left: var(--space-16);
        }

        /* Utility classes */
        .flex {
          display: flex;
        }
        .flex-col {
          flex-direction: column;
        }
        .items-center {
          align-items: center;
        }
        .justify-center {
          justify-content: center;
        }
        .justify-between {
          justify-content: space-between;
        }
        .gap-4 {
          gap: var(--space-4);
        }
        .gap-8 {
          gap: var(--space-8);
        }
        .gap-16 {
          gap: var(--space-16);
        }

        .m-0 {
          margin: 0;
        }
        .mt-8 {
          margin-top: var(--space-8);
        }
        .mb-8 {
          margin-bottom: var(--space-8);
        }
        .mx-8 {
          margin-left: var(--space-8);
          margin-right: var(--space-8);
        }
        .my-8 {
          margin-top: var(--space-8);
          margin-bottom: var(--space-8);
        }

        .p-0 {
          padding: 0;
        }
        .py-8 {
          padding-top: var(--space-8);
          padding-bottom: var(--space-8);
        }
        .px-8 {
          padding-left: var(--space-8);
          padding-right: var(--space-8);
        }
        .py-16 {
          padding-top: var(--space-16);
          padding-bottom: var(--space-16);
        }
        .px-16 {
          padding-left: var(--space-16);
          padding-right: var(--space-16);
        }

        .block {
          display: block;
        }
        .hidden {
          display: none !important;
        }

        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border-width: 0;
        }

        :focus-visible {
          outline: var(--focus-outline);
          outline-offset: 2px;
        }

        /* Custom App Styles */
        .app-header {
          background-color: var(--color-surface);
          border-bottom: 1px solid var(--color-border);
          padding: var(--space-16);
          position: sticky;
          top: 0;
          z-index: 100;
        }

        .app-header h1 {
          margin: 0;
          font-size: var(--font-size-2xl);
        }

        .bottom-nav {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: var(--color-surface);
          border-top: 1px solid var(--color-border);
          display: flex;
          justify-content: space-around;
          padding: var(--space-8) 0;
        }

        .nav-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: var(--space-8);
          cursor: pointer;
          transition: color var(--duration-fast);
          font-size: var(--font-size-xs);
          min-width: 60px;
        }

        .nav-item.active {
          color: var(--color-primary);
        }

        .nav-icon {
          width: 24px;
          height: 24px;
          margin-bottom: var(--space-4);
        }

        .main-content {
          padding: var(--space-16);
          margin-bottom: 80px;
        }

        .screen {
          display: none;
        }

        .screen.active {
          display: block;
        }

        .client-card {
          margin-bottom: var(--space-16);
          cursor: pointer;
        }

        .exercise-card {
          margin-bottom: var(--space-16);
          position: relative;
        }

        .muscle-group {
          display: inline-block;
          padding: var(--space-4) var(--space-8);
          border-radius: var(--radius-sm);
          font-size: var(--font-size-xs);
          font-weight: var(--font-weight-medium);
          margin-bottom: var(--space-8);
        }

        .muscle-group--dorso { background-color: var(--color-bg-1); }
        .muscle-group--spalle { background-color: var(--color-bg-2); }
        .muscle-group--bicipiti { background-color: var(--color-bg-3); }
        .muscle-group--tricipiti { background-color: var(--color-bg-4); }
        .muscle-group--petto { background-color: var(--color-bg-5); }
        .muscle-group--gambe { background-color: var(--color-bg-6); }
        .muscle-group--addominali { background-color: var(--color-bg-7); }
        .muscle-group--core { background-color: var(--color-bg-8); }
        .muscle-group--cardio { background-color: var(--color-bg-1); }
        .muscle-group--functional { background-color: var(--color-bg-2); }
        .muscle-group--altro { background-color: var(--color-bg-3); }

        .youtube-btn {
          position: absolute;
          top: var(--space-16);
          right: var(--space-16);
          background: #ff0000;
          color: white;
          border: none;
          padding: var(--space-8);
          border-radius: var(--radius-sm);
          cursor: pointer;
          font-size: var(--font-size-sm);
        }

        .weight-input {
          width: 80px;
          text-align: center;
        }

        .exercise-form {
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          padding: var(--space-16);
          margin-bottom: var(--space-16);
          background-color: var(--color-bg-1);
        }

        .superset-container {
          border: 2px solid var(--color-primary);
          border-radius: var(--radius-lg);
          margin-bottom: var(--space-16);
          position: relative;
          background: rgba(var(--color-teal-500-rgb), 0.05);
        }

        .superset-label {
          position: absolute;
          top: -10px;
          left: var(--space-16);
          background: var(--color-primary);
          color: var(--color-btn-primary-text);
          padding: var(--space-4) var(--space-8);
          border-radius: var(--radius-sm);
          font-size: var(--font-size-xs);
          font-weight: var(--font-weight-bold);
        }

        .recovery-timer {
          background: var(--color-bg-2);
          border-radius: var(--radius-base);
          padding: var(--space-12);
          text-align: center;
          margin: var(--space-16) 0;
          font-weight: var(--font-weight-bold);
        }

        .set-row {
          display: flex;
          align-items: center;
          gap: var(--space-8);
          margin-bottom: var(--space-8);
          padding: var(--space-8);
          background: var(--color-bg-3);
          border-radius: var(--radius-sm);
        }

        .client-management {
          margin-bottom: var(--space-24);
        }

        .form-row {
          display: flex;
          gap: var(--space-16);
        }

        .checkbox-group {
          display: flex;
          align-items: center;
          gap: var(--space-8);
          margin: var(--space-8) 0;
        }

        .checkbox-group input[type="checkbox"] {
          width: 18px;
          height: 18px;
        }
        
        .pt-section {
          display: block;
        }
        
        .pt-section.active {
          display: block;
        }
        
        .progress-bar {
          width: 100%;
          height: 8px;
          background-color: var(--color-secondary);
          border-radius: var(--radius-full);
          overflow: hidden;
          margin: var(--space-8) 0;
        }
        
        .progress-bar-fill {
          height: 100%;
          background-color: var(--color-primary);
          transition: width var(--duration-normal) var(--ease-standard);
        }
        
        .workout-note {
          width: 100%;
          min-height: 80px;
          resize: vertical;
          margin: var(--space-16) 0;
        }

        .remove-exercise {
          background: var(--color-error);
          color: white;
          border: none;
          padding: var(--space-4) var(--space-8);
          border-radius: var(--radius-sm);
          cursor: pointer;
          font-size: var(--font-size-xs);
        }

        .login-container {
          max-width: 400px;
          margin: 50px auto;
          padding: var(--space-32);
        }

        .role-selector {
          display: flex;
          gap: var(--space-16);
          margin-bottom: var(--space-24);
        }

        .role-btn {
          flex: 1;
          padding: var(--space-16);
          border: 2px solid var(--color-border);
          background: var(--color-surface);
          border-radius: var(--radius-base);
          cursor: pointer;
          transition: all var(--duration-fast);
        }

        .role-btn.selected {
          border-color: var(--color-primary);
          background: rgba(var(--color-teal-500-rgb), 0.1);
        }

        @media (max-width: 768px) {
          .container {
            padding-left: var(--space-16);
            padding-right: var(--space-16);
          }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div class="login-container">
                <div class="card">
                    <div class="card__body">
                        <h1 style="text-align: center; margin-bottom: 32px;">PT Workout Manager</h1>
                        
                        <div class="role-selector">
                            <div class="role-btn" onclick="selectRole(&#39;pt&#39;)" id="ptRole">
                                <h3>Personal Trainer</h3>
                                <p style="font-size: 12px; color: var(--color-text-secondary);">Gestisci clienti e workout</p>
                            </div>
                            <div class="role-btn" onclick="selectRole(&#39;client&#39;)" id="clientRole">
                                <h3>Cliente</h3>
                                <p style="font-size: 12px; color: var(--color-text-secondary);">Visualizza i tuoi allenamenti</p>
                            </div>
                        </div>
                        
                        <!-- Loading/Connection Status -->
                        <div id="connectionStatus" class="hidden" style="padding: 8px; margin-bottom: 16px; border-radius: var(--radius-base); text-align: center; font-size: 12px;">
                            üü¢ Connesso a Supabase
                        </div>
                        
                        <div id="loadingSpinner" class="hidden" style="text-align: center; margin: 20px 0;">
                            <div style="display: inline-block; padding: 16px; background: var(--color-bg-1); border-radius: var(--radius-base);">‚è≥ Caricamento...</div>
                        </div>
                        
                        <div id="errorMessage" class="hidden" style="padding: 12px; margin-bottom: 16px; background: var(--color-bg-4); border: 1px solid var(--color-error); border-radius: var(--radius-base); color: var(--color-error); font-size: 14px;"></div>
                        
                        <form id="loginForm" onsubmit="login(event)">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="email" class="form-control" required="">
                                <small style="color: var(--color-text-secondary);">Usa l'email del tuo account Supabase</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" id="password" class="form-control" required="">
                            </div>
                            <button type="submit" class="btn btn--primary btn--full-width" id="loginButton">Accedi</button>
                        </form>
                        
                        <div style="margin-top: 24px; padding: 16px; background: var(--color-bg-2); border-radius: var(--radius-base); font-size: 12px; color: var(--color-text-secondary);">
                            üìù <strong>Setup Iniziale:</strong><br>
                            Per creare gli account PT iniziali:<br>
                            1. Apri Console (F12)<br>
                            2. Esegui: <code>createInitialPT('giulia@pt.com', 'Narbolia123', 'Giulia', 'Giulia_PT')</code><br>
                            3. Esegui: <code>createInitialPT('fab@dev.com', 'Tiferet456', 'Fabio Dev', 'Fab_dev')</code>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- PT Dashboard -->
        <div id="ptDashboard" class="screen">
            <div class="app-header">
                <div class="flex justify-between items-center">
                    <h1>Dashboard PT</h1>
                    <button class="btn btn--outline btn--sm" onclick="logout()">Logout</button>
                </div>
            </div>
            <div class="main-content">
                <!-- PT Dashboard Navigation -->
                <div class="bottom-nav" style="position: static; margin-bottom: 24px; border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-bg-1);">
                    <div class="nav-item active" onclick="showPTSection(&#39;clients&#39;)" id="clientsTab">
                        <div class="nav-icon">üë•</div>
                        <span>Gestione Clienti</span>
                    </div>
                    <div class="nav-item" onclick="showPTSection(&#39;create&#39;)" id="createTab">
                        <div class="nav-icon">üìù</div>
                        <span>Crea Scheda</span>
                    </div>
                    <div class="nav-item" onclick="showPTSection(&#39;monitor&#39;)" id="monitorTab">
                        <div class="nav-icon">üìä</div>
                        <span>Monitor Progressi</span>
                    </div>
                </div>

                <!-- Client Management Section -->
                <div id="clientsSection" class="pt-section active">
                    <div class="client-management">
                        <div class="flex justify-between items-center" style="margin-bottom: 16px;">
                            <h2>Gestione Clienti</h2>
                            <button class="btn btn--primary" onclick="showAddClient()">Aggiungi Nuovo Cliente</button>
                        </div>
                        <div id="clientsList"></div>
                    </div>
                </div>
                
                <!-- Create Workout Section -->
                <div id="createSection" class="pt-section" style="display: none;">
                    <div class="flex justify-between items-center" style="margin-bottom: 24px;">
                        <h2>Crea Schede</h2>
                        <button class="btn btn--primary" onclick="showCreateWorkout()">Nuovo Workout</button>
                    </div>
                </div>
                
                <!-- Monitor Progress Section -->
                <div id="monitorSection" class="pt-section" style="display: none;">
                    <h2>Monitor Progressi</h2>
                    <div id="progressList"></div>
                </div>
            </div>
        </div>

        <!-- Client Dashboard -->
        <div id="clientDashboard" class="screen">
            <div class="app-header">
                <div class="flex justify-between items-center">
                    <h1 id="clientWelcome">Benvenuto</h1>
                    <button class="btn btn--outline btn--sm" onclick="logout()">Logout</button>
                </div>
            </div>
            <div class="main-content">
                <div id="currentWorkout"></div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item active" onclick="showClientScreen(&#39;current&#39;)">
                    <div class="nav-icon">üèãÔ∏è</div>
                    <span>Workout</span>
                </div>
                <div class="nav-item" onclick="showClientScreen(&#39;history&#39;)">
                    <div class="nav-icon">üìä</div>
                    <span>Storico</span>
                </div>
            </div>
        </div>

        <!-- Create Workout Screen -->
        <div id="createWorkout" class="screen">
            <div class="app-header">
                <div class="flex justify-between items-center">
                    <h1>Crea Workout</h1>
                    <button class="btn btn--outline btn--sm" onclick="returnToDashboard()">‚Üê Torna alla Dashboard</button>
                </div>
            </div>
            <div class="main-content">
                <form id="workoutForm" onsubmit="saveWorkout(event)">
                    <div class="form-group">
                        <label class="form-label">Seleziona Cliente</label>
                        <select id="workoutClient" class="form-control" required="">
                            <option value="">Scegli un cliente...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome Programma</label>
                        <select id="programName" class="form-control" required="">
                            <option value="">Seleziona programma...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Numero Completamenti Richiesti</label>
                        <input type="number" id="totalCompletions" class="form-control" min="1" max="20" value="6" required="">
                        <small style="color: var(--color-text-secondary);">Quante volte il cliente deve completare questo workout</small>
                    </div>
                    
                    <h3 style="margin: 24px 0 16px 0;">Esercizi</h3>
                    <div id="exercisesContainer"></div>
                    
                    <button type="button" class="btn btn--secondary btn--full-width" onclick="addExercise()" style="margin-bottom: 16px;">Aggiungi Esercizio</button>
                    
                    <button type="submit" class="btn btn--primary btn--full-width" id="saveWorkoutBtn">Salva Scheda</button>
                </form>
            </div>
        </div>

        <!-- Client History Screen -->
        <div id="clientHistory" class="screen">
            <div class="app-header">
                <h1>Storico Allenamenti</h1>
            </div>
            <div class="main-content">
                <div id="historyList"></div>
            </div>
            <div class="bottom-nav">
                <div class="nav-item" onclick="showClientScreen(&#39;current&#39;)">
                    <div class="nav-icon">üèãÔ∏è</div>
                    <span>Workout</span>
                </div>
                <div class="nav-item active" onclick="showClientScreen(&#39;history&#39;)">
                    <div class="nav-icon">üìä</div>
                    <span>Storico</span>
                </div>
            </div>
        </div>

        <!-- Add Client Screen -->
        <div id="addClientScreen" class="screen">
            <div class="app-header">
                <div class="flex justify-between items-center">
                    <h1>Aggiungi Nuovo Cliente</h1>
                    <button class="btn btn--outline btn--sm" onclick="returnToDashboard()">‚Üê Torna alla Dashboard</button>
                </div>
            </div>
            <div class="main-content">
                <form id="addClientForm" onsubmit="saveNewClient(event)">
                    <div class="form-group">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" id="clientName" class="form-control" required="">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" id="clientUsername" class="form-control" required="">
                        <small style="color: var(--color-text-secondary);">Deve essere unico</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" id="clientPassword" class="form-control" required="" minlength="6">
                        <small style="color: var(--color-text-secondary);">Minimo 6 caratteri</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email (opzionale)</label>
                        <input type="email" id="clientEmail" class="form-control">
                    </div>
                    
                    <button type="submit" class="btn btn--primary btn--full-width">Crea Cliente</button>
                </form>
                
                <div id="clientCreatedMessage" class="hidden" style="margin-top: 24px; padding: 16px; background: var(--color-bg-3); border-radius: var(--radius-base);">
                    <h3>Cliente creato con successo!</h3>
                    <p>Link di accesso:</p>
                    <div style="background: var(--color-surface); padding: 12px; border-radius: var(--radius-sm); margin: 8px 0; font-family: var(--font-family-mono); word-break: break-all;" id="generatedLink"></div>
                    <button class="btn btn--outline btn--sm" onclick="copyToClipboard()">Copia Link</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
        SUPABASE INTEGRATION - PERSONAL TRAINER WORKOUT TRACKER
        
        SECURITY NOTES:
        - Supabase anon key is safe to expose (protected by RLS)
        - Row Level Security (RLS) policies protect data
        - Never store sensitive data in client code
        - Password hashing handled by Supabase Auth
        
        DEPLOYMENT TO NETLIFY:
        1. Your site: giulia-workout-tracker.netlify.app
        2. Go to Netlify dashboard
        3. Drag and drop this index.html file
        4. Or connect to GitHub repo for auto-deploy
        5. Done! App is live with Supabase backend
        
        SETUP INITIAL PT ACCOUNTS:
        1. Open browser console on the app
        2. Run: createInitialPT('giulia@pt.com', 'Narbolia123', 'Giulia', 'Giulia_PT')
        3. Run: createInitialPT('fab@dev.com', 'Tiferet456', 'Fabio Dev', 'Fab_dev')
        4. These will create the PT accounts in Supabase
        */
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://nkvkmqelojtagdhlqlyu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rdmttcWVsb2p0YWdkaGxxbHl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjQ1MzgsImV4cCI6MjA3NjY0MDUzOH0.wCfpU-cWdGRbCBa6HB7ms7MQ8WeEeJNL5VHs8di3mls';
        
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global State
        let currentUser = null;
        let selectedRole = 'pt';
        let exerciseCounter = 0;
        let editingWorkoutId = null;
        let currentWorkoutNote = '';
        
        // Static Data
        const muscleGroups = ['Dorso', 'Spalle', 'Bicipiti', 'Tricipiti', 'Petto', 'Gambe', 'Addominali', 'Core', 'Cardio', 'Functional', 'Altro'];
        const recoveryTimeOptions = [30, 60, 90, 120, 180, 240, 300];
        const supersetGroups = ['A', 'B', 'C', 'D', 'E'];
        const programNames = ['Scheda 1', 'Scheda 2', 'Scheda 3', 'Scheda 4', 'Scheda 5', 'Scheda 6', 'Scheda 7'];
        
        // Firebase Authentication State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    showLoading(true);
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            ...userData
                        };
                        
                        showConnectionStatus();
                        
                        if (userData.role === 'pt') {
                            showPTDashboard();
                        } else {
                            showClientDashboard();
                        }
                    } else {
                        showError('Dati utente non trovati nel database.');
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showError('Errore nel caricamento dei dati utente: ' + error.message);
                    await auth.signOut();
                } finally {
                    showLoading(false);
                }
            } else {
                currentUser = null;
                showLoginPage();
            }
        });
        
        // UI Helper Functions
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.classList.toggle('hidden', !show);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                setTimeout(() => errorDiv.classList.add('hidden'), 5000);
            } else {
                alert(message);
            }
        }
        
        function showConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (statusDiv) {
                statusDiv.innerHTML = 'üü¢ Connesso a Supabase';
                statusDiv.classList.remove('hidden');
                statusDiv.style.background = 'var(--color-bg-3)';
                statusDiv.style.border = '1px solid var(--color-success)';
                statusDiv.style.color = 'var(--color-success)';
                setTimeout(() => statusDiv.classList.add('hidden'), 3000);
            }
        }
        
        function showLoginPage() {
            showScreen('loginScreen');
            showLoading(false);
            document.getElementById('connectionStatus').classList.add('hidden');
        }

        const workouts = [
            {
                id: 1,
                clientId: 3,
                programName: 'Scheda 1',
                totalCompletions: 6,
                currentCompletions: 2,
                createdDate: '2025-10-10',
                status: 'active',
                exercises: [
                    {
                        name: 'Panca Piana',
                        muscleGroup: 'Petto',
                        sets: 4,
                        reps: '12-10-8-6',
                        recoveryTime: 120,
                        suggestedWeight: 60,
                        actualWeights: [null, null, null, null],
                        youtubeLink: 'https://youtube.com/watch?v=bench_press',
                        isSuperset: false,
                        supersetGroup: null
                    },
                    {
                        name: 'Croci Manubri',
                        muscleGroup: 'Petto',
                        sets: 3,
                        reps: '12-10-8',
                        recoveryTime: 0,
                        suggestedWeight: 18,
                        actualWeights: [null, null, null],
                        youtubeLink: 'https://youtube.com/watch?v=flyes',
                        isSuperset: true,
                        supersetGroup: 'A'
                    },
                    {
                        name: 'Push-up',
                        muscleGroup: 'Petto',
                        sets: 3,
                        reps: '15-12-10',
                        recoveryTime: 90,
                        suggestedWeight: 0,
                        actualWeights: [null, null, null],
                        youtubeLink: 'https://youtube.com/watch?v=pushup',
                        isSuperset: true,
                        supersetGroup: 'A'
                    },
                    {
                        name: 'Plank',
                        muscleGroup: 'Core',
                        sets: 3,
                        reps: '60-45-45',
                        recoveryTime: 60,
                        suggestedWeight: 0,
                        actualWeights: [null, null, null],
                        youtubeLink: 'https://youtube.com/watch?v=plank',
                        isSuperset: false,
                        supersetGroup: null
                    },
                    {
                        name: 'Lat Machine',
                        muscleGroup: 'Dorso',
                        sets: 4,
                        reps: '12',
                        recoveryTime: 90,
                        suggestedWeight: 50,
                        actualWeights: [null, null, null, null],
                        youtubeLink: 'https://youtube.com/watch?v=lat_pulldown',
                        isSuperset: false,
                        supersetGroup: null
                    }
                ],
                completionHistory: [
                    {
                        date: '2025-10-12',
                        time: '18:30',
                        clientNote: 'Ottima sessione, mi sono sentito forte',
                        weightsUsed: [[60,62,65,67],[18,18,20],[0,0,0],[0,0,0],[50,50,52,55]]
                    },
                    {
                        date: '2025-10-15',
                        time: '19:00',
                        clientNote: 'Un po\' stanco ma completato tutto',
                        weightsUsed: [[60,60,62,65],[18,20,20],[0,0,0],[0,0,0],[50,50,50,52]]
                    }
                ]
            },
            {
                id: 2,
                clientId: 3,
                programName: 'Scheda 2',
                totalCompletions: 4,
                currentCompletions: 0,
                createdDate: '2025-10-18',
                status: 'active',
                exercises: [
                    {
                        name: 'Squat',
                        muscleGroup: 'Gambe',
                        sets: 4,
                        reps: '10-8-8-6',
                        recoveryTime: 120,
                        suggestedWeight: 80,
                        actualWeights: [null, null, null, null],
                        youtubeLink: 'https://youtube.com/watch?v=squat',
                        isSuperset: false,
                        supersetGroup: null
                    },
                    {
                        name: 'Leg Curl',
                        muscleGroup: 'Gambe',
                        sets: 3,
                        reps: '12-10-8',
                        recoveryTime: 90,
                        suggestedWeight: 40,
                        actualWeights: [null, null, null],
                        youtubeLink: 'https://youtube.com/watch?v=leg_curl',
                        isSuperset: false,
                        supersetGroup: null
                    }
                ],
                completionHistory: []
            }
        ];

        // Utility Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // CRITICAL FIX: Reliable navigation function for dashboard return
        function returnToDashboard() {
            console.log('returnToDashboard called');
            
            // Force hide all screens except PT dashboard
            const allScreens = ['loginScreen', 'clientDashboard', 'createWorkout', 'clientHistory', 'addClientScreen'];
            allScreens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.remove('active');
                    screen.style.display = 'none';
                }
            });
            
            // Show PT dashboard
            const ptDashboard = document.getElementById('ptDashboard');
            if (ptDashboard) {
                ptDashboard.classList.add('active');
                ptDashboard.style.display = 'block';
            }
            
            // Reset to clients tab (first tab)
            const tabs = ['clientsSection', 'createSection', 'monitorSection'];
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) tab.style.display = 'none';
            });
            
            // Show clients section
            const clientsSection = document.getElementById('clientsSection');
            if (clientsSection) {
                clientsSection.style.display = 'block';
            }
            
            // Update tab buttons
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(btn => btn.classList.remove('active'));
            const clientsTab = document.getElementById('clientsTab');
            if (clientsTab) {
                clientsTab.classList.add('active');
            }
            
            // Clear any editing states
            window.editingWorkoutId = null;
            currentWorkoutNote = '';
            
            // Clear workout form
            clearWorkoutForm();
            
            // Reload clients view
            if (typeof loadClientsList === 'function') {
                loadClientsList();
            }
            
            console.log('Dashboard shown successfully');
        }
        
        // Alias for backward compatibility
        function goToDashboard() {
            return returnToDashboard();
        }

        function clearWorkoutForm() {
            const form = document.getElementById('workoutForm');
            if (form) {
                form.reset();
                document.getElementById('exercisesContainer').innerHTML = '';
                exerciseCounter = 0;
                // Reset button text
                const saveBtn = document.getElementById('saveWorkoutBtn');
                if (saveBtn) {
                    saveBtn.textContent = 'üíæ Salva Scheda';
                }
            }
        }

        function getMuscleGroupClass(group) {
            return 'muscle-group--' + group.toLowerCase().replace(/\s+/g, '');
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Non disponibile';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    return 'Non disponibile';
                }
                return date.toLocaleDateString('it-IT');
            } catch (e) {
                return 'Non disponibile';
            }
        }

        // Supabase Authentication Functions
        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(role + 'Role').classList.add('selected');
        }

        async function login(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            
            if (!email || !password) {
                showError('Inserisci email e password');
                return;
            }
            
            try {
                showLoading(true);
                loginButton.disabled = true;
                loginButton.textContent = '‚è≥ Accesso...';
                
                // Supabase Auth login
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                // Get user profile from users table
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();
                
                if (userError) {
                    throw new Error('Dati utente non trovati. Contatta l\'amministratore.');
                }
                
                // Check if user role matches selected role
                if (userData.role !== selectedRole) {
                    await supabaseClient.auth.signOut();
                    throw new Error(`Questo account non ha i permessi per accedere come ${selectedRole === 'pt' ? 'Personal Trainer' : 'Cliente'}`);
                }
                
                // Login successful - auth state listener will handle navigation
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Errore durante l\'accesso';
                
                if (error.message === 'Invalid login credentials') {
                    errorMessage = 'Email o password non validi';
                } else if (error.message === 'Email not confirmed') {
                    errorMessage = 'Email non confermata. Controlla la tua casella di posta.';
                } else if (error.message === 'Too many requests') {
                    errorMessage = 'Troppi tentativi falliti. Riprova pi√π tardi.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
            } finally {
                showLoading(false);
                loginButton.disabled = false;
                loginButton.textContent = 'Accedi';
            }
        }

        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                // Auth state listener will handle UI updates
            } catch (error) {
                console.error('Logout error:', error);
                showError('Errore durante il logout: ' + error.message);
            }
        }

        // Supabase CRUD Operations
        
        // Create User (Client)
        async function createClient(ptId, clientData) {
            try {
                // Create auth user
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: clientData.email,
                    password: clientData.password
                });
                
                if (authError) throw authError;
                
                // Insert user profile in users table
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert([{
                        id: authData.user.id,
                        email: clientData.email,
                        name: clientData.name,
                        username: clientData.username,
                        role: 'client',
                        assigned_pt_id: ptId,
                        is_protected: false
                    }])
                    .select();
                
                if (error) throw error;
                return authData.user.id;
            } catch (error) {
                console.error('Error creating client:', error);
                throw error;
            }
        }
        
        // Create Workout
        async function createWorkout(workoutData) {
            try {
                const { data, error } = await supabaseClient
                    .from('workouts')
                    .insert([{
                        client_id: workoutData.clientId,
                        client_name: workoutData.clientName,
                        program_name: workoutData.programName,
                        total_completions: workoutData.totalCompletions,
                        current_completions: 0,
                        status: 'active',
                        exercises: workoutData.exercises,
                        completion_history: []
                    }])
                    .select();
                
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error creating workout:', error);
                throw error;
            }
        }
        
        // Read Workouts
        async function loadClientWorkouts(clientId) {
            try {
                const { data, error } = await supabaseClient
                    .from('workouts')
                    .select('*')
                    .eq('client_id', clientId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error loading client workouts:', error);
                throw error;
            }
        }
        
        // Update Workout
        async function updateWorkout(workoutId, updates) {
            try {
                const { data, error } = await supabaseClient
                    .from('workouts')
                    .update(updates)
                    .eq('id', workoutId)
                    .select();
                
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error updating workout:', error);
                throw error;
            }
        }
        
        // Delete Workout
        async function deleteWorkout(workoutId) {
            try {
                const { error } = await supabaseClient
                    .from('workouts')
                    .delete()
                    .eq('id', workoutId);
                
                if (error) throw error;
            } catch (error) {
                console.error('Error deleting workout:', error);
                throw error;
            }
        }
        
        // Complete Workout
        async function completeWorkout(workoutId, completionData) {
            try {
                // Get current workout
                const { data: workout, error: fetchError } = await supabaseClient
                    .from('workouts')
                    .select('*')
                    .eq('id', workoutId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                const newCompletions = workout.current_completions + 1;
                const newHistory = [...(workout.completion_history || []), completionData];
                const newStatus = newCompletions >= workout.total_completions ? 'expired' : 'active';
                
                // Update workout
                const { data, error } = await supabaseClient
                    .from('workouts')
                    .update({
                        current_completions: newCompletions,
                        completion_history: newHistory,
                        status: newStatus
                    })
                    .eq('id', workoutId)
                    .select();
                
                if (error) throw error;
                return { 
                    newCompletions, 
                    totalCompletions: workout.total_completions, 
                    newStatus 
                };
            } catch (error) {
                console.error('Error completing workout:', error);
                throw error;
            }
        }
        
        // Load PT Clients
        async function loadPTClients(ptId) {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('assigned_pt_id', ptId)
                    .eq('role', 'client')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data.map(client => ({ uid: client.id, ...client }));
            } catch (error) {
                console.error('Error loading PT clients:', error);
                throw error;
            }
        }
        
        // Load All Workouts for PT
        async function loadPTWorkouts(ptId) {
            try {
                // First get all clients of this PT
                const clients = await loadPTClients(ptId);
                const clientIds = clients.map(c => c.uid);
                
                if (clientIds.length === 0) {
                    return [];
                }
                
                // Get workouts for all clients
                const { data: workouts, error } = await supabaseClient
                    .from('workouts')
                    .select('*')
                    .in('client_id', clientIds)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Add client names
                return workouts.map(workout => {
                    const client = clients.find(c => c.uid === workout.client_id);
                    return {
                        ...workout,
                        clientId: workout.client_id,
                        clientName: workout.client_name || (client ? client.name : 'Cliente rimosso'),
                        programName: workout.program_name,
                        totalCompletions: workout.total_completions,
                        currentCompletions: workout.current_completions,
                        completionHistory: workout.completion_history || [],
                        createdDate: workout.created_at
                    };
                });
            } catch (error) {
                console.error('Error loading PT workouts:', error);
                throw error;
            }
        }
        
        // Utility functions
        function parseReps(repsString) {
            if (repsString.includes('-')) {
                return repsString.split('-').map(r => parseInt(r.trim()));
            }
            return [parseInt(repsString)];
        }
        
        function generateAccessLink(username) {
            const randomString = Math.random().toString(36).substring(2, 8);
            return `/client/${username}_${randomString}`;
        }
        
        async function validateUsername(username) {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('id')
                    .eq('username', username)
                    .limit(1);
                
                if (error) throw error;
                return data.length === 0;
            } catch (error) {
                console.error('Error validating username:', error);
                return false;
            }
        }
        
        // Function to create initial PT accounts (call manually in console)
        async function createInitialPT(email, password, name, username) {
            try {
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                // Wait a moment for auth user to be created
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const { error: insertError } = await supabaseClient
                    .from('users')
                    .insert([{
                        id: authData.user.id,
                        email: email,
                        name: name,
                        username: username,
                        role: 'pt',
                        assigned_pt_id: null,
                        is_protected: username === 'Fab_dev'
                    }]);
                
                if (insertError) throw insertError;
                
                console.log('PT account created successfully!', { email, name, username });
                return authData.user.id;
            } catch (error) {
                console.error('Error creating PT:', error);
                throw error;
            }
        }
        
        // Make createInitialPT available globally for console use
        window.createInitialPT = createInitialPT;

        // PT Dashboard Functions
        function showPTDashboard() {
            // CRITICAL FIX: Ensure login is hidden and PT dashboard is shown
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('clientDashboard').classList.remove('active');
            document.getElementById('ptDashboard').classList.add('active');
            
            // Initialize PT dashboard
            showPTSection('clients');
            clearWorkoutForm();
            editingWorkoutId = null;
            currentWorkoutNote = '';
        }
        
        function showPTSection(section) {
            // Hide all sections
            document.querySelectorAll('.pt-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Show selected section
            const sectionMap = {
                'clients': 'clientsSection',
                'create': 'createSection', 
                'monitor': 'monitorSection'
            };
            
            document.getElementById(sectionMap[section]).style.display = 'block';
            document.getElementById(section + 'Tab').classList.add('active');
            
            // Load data for section
            if (section === 'clients') {
                loadClientsList();
            } else if (section === 'monitor') {
                loadProgressMonitor();
            }
        }

        function showAddClient() {
            showScreen('addClientScreen');
            document.getElementById('addClientForm').reset();
            document.getElementById('clientCreatedMessage').classList.add('hidden');
        }

        async function saveNewClient(event) {
            event.preventDefault();
            
            const name = document.getElementById('clientName').value.trim();
            const username = document.getElementById('clientUsername').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const password = document.getElementById('clientPassword').value;
            
            if (!name || !username || !email || !password) {
                showError('Tutti i campi sono obbligatori');
                return;
            }
            
            try {
                showLoading(true);
                
                // Validate username uniqueness (skip if empty)
                if (username) {
                    const isUsernameValid = await validateUsername(username);
                    if (!isUsernameValid) {
                        throw new Error('Username gi√† in uso. Scegli un username diverso.');
                    }
                }
                
                // Create client
                const clientData = {
                    name,
                    username,
                    email,
                    password
                };
                
                const newClientId = await createClient(currentUser.uid, clientData);
                
                // Generate access link (for display only)
                const accessLink = generateAccessLink(username);
                
                // Show success message
                document.getElementById('generatedLink').textContent = `${window.location.origin}${accessLink}`;
                document.getElementById('clientCreatedMessage').classList.remove('hidden');
                document.getElementById('addClientForm').reset();
                
                // Refresh clients list if visible
                if (document.getElementById('clientsSection').style.display !== 'none') {
                    await loadClientsList();
                }
                
            } catch (error) {
                console.error('Error creating client:', error);
                let errorMessage = 'Errore durante la creazione del cliente';
                
                if (error.message === 'User already registered') {
                    errorMessage = 'Email gi√† registrata. Usa un\'altra email.';
                } else if (error.message === 'Password should be at least 6 characters') {
                    errorMessage = 'Password troppo debole. Usa almeno 6 caratteri.';
                } else if (error.message.includes('Invalid email')) {
                    errorMessage = 'Formato email non valido.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
            } finally {
                showLoading(false);
            }
        }
        
        function copyToClipboard() {
            const linkText = document.getElementById('generatedLink').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                alert('Link copiato negli appunti!');
            }).catch(() => {
                alert('Impossibile copiare il link');
            });
        }

        async function loadProgressMonitor() {
            const container = document.getElementById('progressList');
            
            try {
                showLoading(true);
                const allWorkouts = await loadPTWorkouts(currentUser.uid);
            
                if (allWorkouts.length === 0) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="card__body">
                                <p>Nessun workout da monitorare.</p>
                                <p style="color: var(--color-text-secondary); font-size: 14px;">Crea delle schede per i tuoi clienti per iniziare il monitoraggio.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
            
                container.innerHTML = allWorkouts.map(workout => {
                    const progress = (workout.currentCompletions / workout.totalCompletions) * 100;
                
                // FIX: Show proper workout status instead of dates
                const workoutStatus = workout.status === 'active' ? 
                    `${workout.programName} in corso` : 
                    `${workout.programName} completata`;
                
                const lastSessionText = workout.completionHistory && workout.completionHistory.length > 0 ? 
                    `Ultima sessione: ${formatDate(workout.completionHistory[workout.completionHistory.length - 1].date)}` : 
                    'Nessuna sessione completata';
                
                    return `
                        <div class="card" style="margin-bottom: 16px;">
                            <div class="card__body">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4>${workoutStatus}</h4>
                                        <p style="color: var(--color-text-secondary); margin: 4px 0;">${workout.clientName}</p>
                                    </div>
                                    <div class="status ${workout.status === 'active' ? 'status--success' : 'status--info'}">
                                        ${workout.status === 'active' ? 'Attiva' : 'Completata'}
                                    </div>
                                </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                            </div>
                            <div class="flex justify-between items-center" style="font-size: 12px; color: var(--color-text-secondary);">
                                <span>Completamenti: ${workout.currentCompletions}/${workout.totalCompletions}</span>
                                <span>${lastSessionText}</span>
                            </div>
                            
                                <!-- Action Buttons with EDIT functionality -->
                                <div class="flex gap-8" style="margin-top: 16px;">
                                    <button class="btn btn--secondary btn--sm" onclick="editWorkout('${workout.id}')">‚úèÔ∏è Modifica Scheda</button>
                                    <button class="btn btn--outline btn--sm" onclick="viewWorkoutDetails('${workout.id}')">üëÅÔ∏è Dettagli</button>
                                    <button class="btn btn--sm" onclick="deleteWorkoutFirebase('${workout.id}')" style="background: var(--color-error); color: white; border: 1px solid var(--color-error);">üóëÔ∏è Elimina</button>
                                </div>
                            
                            ${workout.completionHistory && workout.completionHistory.length > 0 ? `
                                <details style="margin-top: 12px;">
                                    <summary style="cursor: pointer; color: var(--color-primary);">Storico Completamenti (${workout.completionHistory.length})</summary>
                                    <div style="margin-top: 8px;">
                                        ${workout.completionHistory.slice().reverse().map(completion => `
                                            <div style="padding: 8px; background: var(--color-bg-1); border-radius: var(--radius-sm); margin: 4px 0; font-size: 12px;">
                                                <div class="flex justify-between">
                                                    <span><strong>${formatDate(completion.date)} alle ${completion.time}</strong></span>
                                                </div>
                                                ${completion.clientNote ? `<div style="margin-top: 4px; font-style: italic;">${completion.clientNote}</div>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    </div>
                `;
                        }).join('');
                    
            } catch (error) {
                console.error('Error loading client history:', error);
                showError('Errore nel caricamento dello storico: ' + error.message);
                container.innerHTML = `
                    <div class="card">
                        <div class="card__body">
                            <h3>Errore nel caricamento</h3>
                            <p>Impossibile caricare lo storico. Riprova.</p>
                            <button class="btn btn--outline" onclick="loadClientHistory()">Ricarica</button>
                        </div>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }
                
            } catch (error) {
                console.error('Error loading clients list:', error);
                showError('Errore nel caricamento dei clienti: ' + error.message);
                clientsContainer.innerHTML = `
                    <div class="card">
                        <div class="card__body">
                            <h3>Errore nel caricamento</h3>
                            <p>Impossibile caricare la lista clienti. Riprova.</p>
                            <button class="btn btn--outline" onclick="loadClientsList()">Ricarica</button>
                        </div>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }
        
        async function loadClientsList() {
            const clientsContainer = document.getElementById('clientsList');
            
            try {
                showLoading(true);
                const clients = await loadPTClients(currentUser.uid);
                
                if (clients.length === 0) {
                    clientsContainer.innerHTML = `
                        <div class="card">
                            <div class="card__body">
                                <h3>Nessun cliente registrato</h3>
                                <p>Usa il pulsante "Aggiungi Nuovo Cliente" per iniziare.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Load workout counts for each client
                const clientsWithWorkouts = await Promise.all(
                    clients.map(async (client) => {
                        try {
                            const clientWorkouts = await loadClientWorkouts(client.uid);
                            const activeWorkouts = clientWorkouts.filter(w => w.status === 'active').length;
                            const expiredWorkouts = clientWorkouts.filter(w => w.status === 'expired').length;
                            return { 
                                ...client, 
                                activeWorkouts, 
                                expiredWorkouts,
                                createdDate: client.created_at
                            };
                        } catch (error) {
                            console.error('Error loading workouts for client:', client.uid, error);
                            return { ...client, activeWorkouts: 0, expiredWorkouts: 0 };
                        }
                    })
                );
                
                clientsContainer.innerHTML = clientsWithWorkouts.map(client => {
                // Workout counts are already loaded
                const { activeWorkouts, expiredWorkouts } = client;
                
                return `
                    <div class="card client-card" onclick="viewClientDetails('${client.uid}')">
                        <div class="card__body">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3>${client.name}</h3>
                                    <p style="color: var(--color-text-secondary); margin: 4px 0;">@${client.username}</p>
                                    <p style="color: var(--color-text-secondary); margin: 4px 0; font-size: 12px;">${client.email}</p>
                                    <p style="color: var(--color-text-secondary); margin: 4px 0; font-size: 11px;">Creato: ${formatDate(client.createdDate)}</p>
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn btn--outline btn--sm" onclick="event.stopPropagation(); editClient('${client.uid}')" style="margin-bottom: 8px;">Modifica</button><br>
                                    <button class="btn btn--outline btn--sm" onclick="event.stopPropagation(); copyClientLink('${client.uid}')">Copia Link</button>
                                </div>
                            </div>
                            <div class="flex gap-16" style="margin-top: 12px;">
                                <div class="status status--info">Attivi: ${activeWorkouts}</div>
                                <div class="status status--success">Completati: ${expiredWorkouts}</div>
                            </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading progress monitor:', error);
                showError('Errore nel caricamento del monitoraggio: ' + error.message);
                container.innerHTML = `
                    <div class="card">
                        <div class="card__body">
                            <h3>Errore nel caricamento</h3>
                            <p>Impossibile caricare il monitoraggio. Riprova.</p>
                            <button class="btn btn--outline" onclick="loadProgressMonitor()">Ricarica</button>
                        </div>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }
        
        async function editClient(clientId) {
            try {
                showLoading(true);
                
                const { data: client, error: clientError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', clientId)
                    .single();
                
                if (clientError || !client) {
                    alert('Cliente non trovato.');
                    return;
                }
                
                client.uid = client.id;
            
            // Create edit form
            const editHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="closeEditClient()">
                    <div class="card" style="width: 90%; max-width: 400px; margin: 0;" onclick="event.stopPropagation();">
                        <div class="card__header">
                            <h3>Modifica Cliente</h3>
                        </div>
                        <div class="card__body">
                            <form id="editClientForm" onsubmit="saveClientChanges('${clientId}', event)">
                                <div class="form-group">
                                    <label class="form-label">Nome</label>
                                    <input type="text" id="editName" class="form-control" value="${client.name}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Username</label>
                                    <input type="text" id="editUsername" class="form-control" value="${client.username}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="editEmail" class="form-control" value="${client.email}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nuova Password (lascia vuoto per non cambiare)</label>
                                    <input type="password" id="editPassword" class="form-control" ${client.isProtected && currentUser.id !== client.id ? 'disabled placeholder="Password protetta"' : ''}>
                                    ${client.isProtected && currentUser.id !== client.id ? '<small style="color: var(--color-error);">Non puoi modificare questa password</small>' : ''}
                                </div>
                                <div class="flex gap-16">
                                    <button type="button" class="btn btn--outline" onclick="closeEditClient()">Annulla</button>
                                    <button type="submit" class="btn btn--primary">Salva</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
                document.body.insertAdjacentHTML('beforeend', editHtml);
                
            } catch (error) {
                console.error('Error loading client for edit:', error);
                showError('Errore nel caricamento del cliente: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function closeEditClient() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }
        
        async function saveClientChanges(clientId, event) {
            event.preventDefault();
            
            const newName = document.getElementById('editName').value.trim();
            const newUsername = document.getElementById('editUsername').value.trim();
            const newEmail = document.getElementById('editEmail').value.trim();
            const newPassword = document.getElementById('editPassword').value;
            
            if (!newName || !newUsername || !newEmail) {
                alert('Nome, username e email sono obbligatori.');
                return;
            }
            
            try {
                showLoading(true);
                
                // Get current client data
                const clientDoc = await db.collection('users').doc(clientId).get();
                if (!clientDoc.exists) {
                    alert('Cliente non trovato.');
                    return;
                }
                const client = clientDoc.data();
                
                // Check username uniqueness (excluding current client)
                if (newUsername !== client.username) {
                    const isUsernameValid = await validateUsername(newUsername);
                    if (!isUsernameValid) {
                        alert('Username gi√† in uso.');
                        return;
                    }
                }
                
                // Check if trying to modify protected password
                if (newPassword && client.is_protected && currentUser.uid !== clientId) {
                    alert('Non puoi modificare questa password.');
                    return;
                }
                
                // Update client data in Supabase
                const updates = {
                    name: newName,
                    username: newUsername,
                    email: newEmail
                };
                
                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update(updates)
                    .eq('id', clientId);
                
                if (updateError) throw updateError;
                
                // Update password if provided (Firebase Auth)
                if (newPassword) {
                    // Note: In a real app, password updates should be handled through Firebase Auth
                    // This is a simplified version
                    console.log('Password update requested - should be handled through Firebase Auth methods');
                }
                
                closeEditClient();
                await loadClientsList();
                alert('Cliente aggiornato con successo!');
                
            } catch (error) {
                console.error('Error saving client changes:', error);
                showError('Errore durante l\'aggiornamento: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function copyClientLink(clientId) {
            try {
                const { data: client, error: clientError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', clientId)
                    .single();
                
                if (clientError || !client) {
                    alert('Cliente non trovato.');
                    return;
                }
                const accessLink = generateAccessLink(client.username);
                const fullLink = window.location.origin + accessLink;
                
                await navigator.clipboard.writeText(fullLink);
                alert('Link copiato negli appunti!');
            } catch (error) {
                console.error('Error copying client link:', error);
                alert('Impossibile copiare il link');
            }
        }

        async function viewClientDetails(clientId) {
            try {
                showLoading(true);
                
                const clientDoc = await db.collection('users').doc(clientId).get();
                if (!clientDoc.exists) {
                    alert('Cliente non trovato.');
                    return;
                }
                
                const client = { uid: clientDoc.id, ...clientDoc.data() };
                const clientWorkouts = await loadClientWorkouts(clientId);
            
            let html = `<h2>Dettagli Cliente: ${client.name}</h2>`;
            
            if (clientWorkouts.length === 0) {
                html += '<p>Nessun workout assegnato</p>';
            } else {
                html += clientWorkouts.map(workout => `
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card__body">
                            <div class="flex justify-between items-center">
                                <h4>Workout del ${formatDate(workout.date)}</h4>
                                <div class="status ${workout.completedDate ? 'status--success' : 'status--warning'}">
                                    ${workout.completedDate ? 'Completato il ' + formatDate(workout.completedDate) : 'In attesa'}
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                ${workout.exercises.map(ex => `
                                    <div style="padding: 8px 0; border-bottom: 1px solid var(--color-border);">
                                        <strong>${ex.name}</strong> (${ex.muscleGroup})<br>
                                        <small>Serie: ${ex.sets}, Ripetizioni: ${ex.reps}, 
                                        Peso suggerito: ${ex.suggestedWeight}kg
                                        ${ex.actualWeight ? `, Peso effettivo: ${ex.actualWeight}kg` : ''}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
                html += '<button class="btn btn--outline" onclick="showPTDashboard()">‚Üê Ritorna alla Dashboard</button>';
                
                document.getElementById('ptDashboard').querySelector('.main-content').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading client details:', error);
                showError('Errore nel caricamento dei dettagli cliente: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Create Workout Functions
        function showCreateWorkout() {
            showScreen('createWorkout');
            loadWorkoutClients();
            document.getElementById('exercisesContainer').innerHTML = '';
            exerciseCounter = 0;
            editingWorkoutId = null; // Ensure we're in create mode
            
            // Reset header for create mode
            document.querySelector('#createWorkout .app-header h1').textContent = 'Crea Workout';
            document.querySelector('#createWorkout .app-header h1').style.background = '';
            document.querySelector('#createWorkout .app-header h1').style.padding = '';
            document.querySelector('#createWorkout .app-header h1').style.borderRadius = '';
            
            // Remove any existing cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.remove();
            
            // Reset save button text
            const saveBtn = document.getElementById('saveWorkoutBtn');
            if (saveBtn) {
                saveBtn.textContent = 'üíæ Salva Scheda';
            }
            
            addExercise();
        }

        async function loadWorkoutClients() {
            const select = document.getElementById('workoutClient');
            
            try {
                const clients = await loadPTClients(currentUser.uid);
                select.innerHTML = '<option value="">Scegli un cliente...</option>' +
                    clients.map(client => `<option value="${client.uid}">${client.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading workout clients:', error);
                select.innerHTML = '<option value="">Errore nel caricamento clienti</option>';
                showError('Errore nel caricamento dei clienti: ' + error.message);
            }
        }

        function addExercise() {
            exerciseCounter++;
            const container = document.getElementById('exercisesContainer');
            
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise-form';
            exerciseDiv.id = `exercise-${exerciseCounter}`;
            
            exerciseDiv.innerHTML = `
                <div class="flex justify-between items-center" style="margin-bottom: 16px;">
                    <h4>Esercizio ${exerciseCounter}</h4>
                    <button type="button" class="remove-exercise" onclick="removeExercise(${exerciseCounter})">Rimuovi</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nome Esercizio</label>
                    <input type="text" class="form-control" name="exerciseName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Gruppo Muscolare</label>
                    <select class="form-control" name="muscleGroup" required>
                        <option value="">Seleziona gruppo...</option>
                        ${muscleGroups.map(group => `<option value="${group}">${group}</option>`).join('')}
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Serie</label>
                        <input type="number" class="form-control" name="sets" min="1" max="10" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Ripetizioni</label>
                        <input type="text" class="form-control" name="reps" placeholder="es: 10 o 10-8-8-6" required>
                        <small style="color: var(--color-text-secondary);">Singolo numero o progressivo (es: 10-8-8-6)</small>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Peso Suggerito (kg)</label>
                        <input type="number" class="form-control" name="suggestedWeight" min="0" step="0.5">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Tempo di Recupero</label>
                        <select class="form-control" name="recoveryTime">
                            ${recoveryTimeOptions.map(time => `<option value="${time}">${time}s</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Superset</label>
                        <select class="form-control" name="supersetGroup">
                            <option value="">Nessuno</option>
                            ${supersetGroups.map(group => `<option value="${group}">Superset ${group}</option>`).join('')}
                        </select>
                        <small style="color: var(--color-text-secondary);">Se superset, il recupero si applica solo alla fine del gruppo</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Link YouTube (opzionale)</label>
                    <input type="url" class="form-control" name="youtubeLink" placeholder="https://youtube.com/watch?v=...">
                </div>
            `;
            
            container.appendChild(exerciseDiv);
        }

        function removeExercise(id) {
            const element = document.getElementById(`exercise-${id}`);
            if (element) {
                element.remove();
            }
        }

        // EDIT WORKOUT FUNCTIONALITY with Firebase
        async function editWorkout(workoutId) {
            try {
                showLoading(true);
                
                // Get workout from Supabase
                const { data: workoutData, error: workoutError } = await supabaseClient
                    .from('workouts')
                    .select('*')
                    .eq('id', workoutId)
                    .single();
                
                if (workoutError || !workoutData) {
                    alert('Scheda non trovata.');
                    return;
                }
                
                const workout = {
                    id: workoutData.id,
                    clientId: workoutData.client_id,
                    programName: workoutData.program_name,
                    totalCompletions: workoutData.total_completions,
                    currentCompletions: workoutData.current_completions,
                    exercises: workoutData.exercises
                };
            
                editingWorkoutId = workoutId;
                
                // Switch to workout creation screen
                showScreen('createWorkout');
                
                // Load clients for dropdown
                await loadWorkoutClients();
            
            // Update header to show edit mode
            document.querySelector('#createWorkout .app-header h1').textContent = 'Modifica Scheda';
            document.querySelector('#createWorkout .app-header h1').style.background = 'var(--color-bg-2)';
            document.querySelector('#createWorkout .app-header h1').style.padding = '8px 16px';
            document.querySelector('#createWorkout .app-header h1').style.borderRadius = 'var(--radius-base)';
            
                // Pre-fill form data
                document.getElementById('workoutClient').value = workout.clientId;
                document.getElementById('programName').value = workout.programName;
                document.getElementById('totalCompletions').value = workout.totalCompletions;
            
                // Clear exercises container and re-populate
                document.getElementById('exercisesContainer').innerHTML = '';
                exerciseCounter = 0;
                
                // Add exercises from workout
                workout.exercises.forEach((exercise, index) => {
                    addExercise();
                    const exerciseForm = document.getElementById(`exercise-${exerciseCounter}`);
                    
                    exerciseForm.querySelector('[name="exerciseName"]').value = exercise.name;
                    exerciseForm.querySelector('[name="muscleGroup"]').value = exercise.muscleGroup;
                    exerciseForm.querySelector('[name="sets"]').value = exercise.sets;
                    exerciseForm.querySelector('[name="reps"]').value = exercise.reps;
                    exerciseForm.querySelector('[name="suggestedWeight"]').value = exercise.suggestedWeight;
                    exerciseForm.querySelector('[name="recoveryTime"]').value = exercise.recoveryTime || 60;
                    exerciseForm.querySelector('[name="supersetGroup"]').value = exercise.supersetGroup || '';
                    exerciseForm.querySelector('[name="youtubeLink"]').value = exercise.youtubeLink || '';
                });
            
                // Change button text and add cancel button
                const saveBtn = document.getElementById('saveWorkoutBtn') || document.querySelector('#workoutForm button[type="submit"]');
                if (saveBtn) {
                    saveBtn.textContent = 'üíæ Salva Modifiche';
                    saveBtn.id = 'saveWorkoutBtn';
                }
                
                // Add cancel button if not exists
                if (!document.getElementById('cancelEditBtn')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'btn btn--outline btn--full-width';
                    cancelBtn.style.marginTop = '8px';
                    cancelBtn.textContent = 'Annulla Modifiche';
                    cancelBtn.id = 'cancelEditBtn';
                    cancelBtn.onclick = function() {
                        if (confirm('Annullare le modifiche? Tutte le modifiche non salvate andranno perse.')) {
                            cancelWorkoutEdit();
                        }
                    };
                    saveBtn.parentNode.insertBefore(cancelBtn, saveBtn.nextSibling);
                }
                
            } catch (error) {
                console.error('Error loading workout for edit:', error);
                showError('Errore nel caricamento della scheda: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function cancelWorkoutEdit() {
            editingWorkoutId = null;
            
            // Reset header
            document.querySelector('#createWorkout .app-header h1').textContent = 'Crea Workout';
            document.querySelector('#createWorkout .app-header h1').style.background = '';
            document.querySelector('#createWorkout .app-header h1').style.padding = '';
            document.querySelector('#createWorkout .app-header h1').style.borderRadius = '';
            
            // Remove cancel button
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.remove();
            
            // Reset form
            clearWorkoutForm();
            
            // Return to monitor tab
            returnToDashboard();
            showPTSection('monitor');
        }

        async function saveWorkout(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('workoutClient').value;
            const programName = document.getElementById('programName').value;
            const totalCompletions = parseInt(document.getElementById('totalCompletions').value);
            
            if (!clientId || !programName || !totalCompletions) {
                showError('Compila tutti i campi obbligatori');
                return;
            }
            
            const saveButton = document.getElementById('saveWorkoutBtn');
            const originalText = saveButton.textContent;
            
            try {
                showLoading(true);
                saveButton.disabled = true;
                saveButton.textContent = '‚è≥ Salvataggio...';
                
                // Get client data
                const { data: client, error: clientError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', clientId)
                    .single();
                
                if (clientError || !client) {
                    throw new Error('Cliente non trovato');
                }
            
            const exercises = [];
            const exerciseForms = document.querySelectorAll('.exercise-form');
            
            let hasError = false;
            exerciseForms.forEach(form => {
                if (hasError) return;
                
                const repsValue = form.querySelector('[name="reps"]').value;
                const sets = parseInt(form.querySelector('[name="sets"]').value);
                const recoveryTime = parseInt(form.querySelector('[name="recoveryTime"]').value);
                const supersetGroup = form.querySelector('[name="supersetGroup"]').value;
                
                // Validate reps format
                const repsArray = parseReps(repsValue);
                if (repsArray.length > 1 && repsArray.length !== sets) {
                    alert(`Errore: per l'esercizio ${form.querySelector('[name="exerciseName"]').value}, il numero di ripetizioni progressive (${repsArray.length}) deve corrispondere al numero di serie (${sets})`);
                    hasError = true;
                    return;
                }
                
                const exercise = {
                    name: form.querySelector('[name="exerciseName"]').value,
                    muscleGroup: form.querySelector('[name="muscleGroup"]').value,
                    sets: sets,
                    reps: repsValue,
                    recoveryTime: supersetGroup ? 0 : recoveryTime,
                    suggestedWeight: parseFloat(form.querySelector('[name="suggestedWeight"]').value) || 0,
                    actualWeights: new Array(sets).fill(null),
                    youtubeLink: form.querySelector('[name="youtubeLink"]').value,
                    isSuperset: !!supersetGroup,
                    supersetGroup: supersetGroup || null
                };
                exercises.push(exercise);
            });
            
            if (hasError) return;
            
            // Apply recovery time to last exercise of each superset
            const supersets = {};
            exercises.forEach((exercise, index) => {
                if (exercise.isSuperset) {
                    if (!supersets[exercise.supersetGroup]) {
                        supersets[exercise.supersetGroup] = [];
                    }
                    supersets[exercise.supersetGroup].push(index);
                }
            });
            
            Object.values(supersets).forEach(indices => {
                const lastIndex = indices[indices.length - 1];
                const recoveryForm = exerciseForms[lastIndex];
                exercises[lastIndex].recoveryTime = parseInt(recoveryForm.querySelector('[name="recoveryTime"]').value);
            });
            
                // Check if we're editing or creating new
                if (editingWorkoutId) {
                    // UPDATE existing workout
                    await updateWorkout(editingWorkoutId, {
                        client_id: clientId,
                        client_name: client.name,
                        program_name: programName,
                        total_completions: totalCompletions,
                        exercises: exercises
                        // Keep existing completion history and current completions
                    });
                    
                    alert('üíæ Scheda modificata con successo!');
                    
                    // Reset edit mode
                    editingWorkoutId = null;
                    document.querySelector('#createWorkout .app-header h1').textContent = 'Crea Workout';
                    document.querySelector('#createWorkout .app-header h1').style.background = '';
                    document.querySelector('#createWorkout .app-header h1').style.padding = '';
                    document.querySelector('#createWorkout .app-header h1').style.borderRadius = '';
                    
                    // Remove cancel button
                    const cancelBtn = document.getElementById('cancelEditBtn');
                    if (cancelBtn) cancelBtn.remove();
                    
                    // Return to monitor
                    returnToDashboard();
                    showPTSection('monitor');
                } else {
                    // CREATE new workout
                    const workoutData = {
                        clientId: clientId,
                        clientName: client.name,
                        programName: programName,
                        totalCompletions: totalCompletions,
                        exercises: exercises
                    };
                    
                    await createWorkout(workoutData);
                    
                    alert('üíæ Scheda creata con successo!');
                    returnToDashboard();
                }
                
            } catch (error) {
                console.error('Error saving workout:', error);
                showError('Errore durante il salvataggio: ' + error.message);
            } finally {
                showLoading(false);
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        }

        // Client Dashboard Functions
        function showClientDashboard() {
            // CRITICAL FIX: Ensure login is hidden and client dashboard is shown
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('ptDashboard').classList.remove('active');
            document.getElementById('clientDashboard').classList.add('active');
            
            // Initialize client dashboard
            document.getElementById('clientWelcome').textContent = `Benvenuto, ${currentUser.name}`;
            loadCurrentWorkout();
        }
        
        let currentWorkoutNote = '';

        async function loadCurrentWorkout() {
            const container = document.getElementById('currentWorkout');
            
            try {
                showLoading(true);
                const clientWorkouts = await loadClientWorkouts(currentUser.uid);
                const activeWorkouts = clientWorkouts.filter(w => w.status === 'active');
            
                if (activeWorkouts.length === 0) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="card__body">
                                <h3>Nessun workout attivo</h3>
                                <p>Contatta il tuo personal trainer per un nuovo programma di allenamento.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
            
                const workout = activeWorkouts[0];
            // Map Supabase field names to expected format
            const normalizedWorkout = {
                ...workout,
                programName: workout.program_name,
                currentCompletions: workout.current_completions,
                totalCompletions: workout.total_completions,
                completionHistory: workout.completion_history || []
            };
            const groupedExercises = groupExercisesBySuperset(normalizedWorkout.exercises);
            const progress = (normalizedWorkout.currentCompletions / normalizedWorkout.totalCompletions) * 100;
            
            // FIXED: Always show program name
            const workoutTitle = `${normalizedWorkout.programName}`;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card__header">
                        <h2>${workoutTitle}</h2>
                        <div class="flex justify-between items-center" style="margin-top: 8px;">
                            <span style="color: var(--color-text-secondary); font-size: 14px;">Completamento ${normalizedWorkout.currentCompletions}/${normalizedWorkout.totalCompletions}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                        </div>
                    </div>
                    <div class="card__body">
                        ${groupedExercises.map(group => {
                            if (group.isSuperset) {
                                return `
                                    <div class="superset-container">
                                        <div class="superset-label">Superset ${group.supersetGroup}</div>
                                        <div style="padding: var(--space-16);">
                                            ${group.exercises.map((exercise, exerciseIndex) => 
                                                renderExerciseCard(exercise, workout.id, exercise.originalIndex, false)
                                            ).join('')}
                                            ${group.recoveryTime > 0 ? `
                                                <div class="recovery-timer">
                                                    üí™ Recupero: ${group.recoveryTime}s
                                                    <div style="font-size: 12px; margin-top: 4px;">dopo tutto il superset</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            } else {
                                return renderExerciseCard(group.exercise, workout.id, group.exercise.originalIndex, true);
                            }
                        }).join('')}
                        
                        <div style="margin-top: 24px; padding: 16px; background: var(--color-bg-2); border-radius: var(--radius-base);">
                            <label class="form-label">Note per questa sessione (opzionale):</label>
                            <textarea class="form-control workout-note" placeholder="Scrivi come ti sei sentito, difficolt√† incontrate, progressi notati..." oninput="currentWorkoutNote = this.value">${currentWorkoutNote}</textarea>
                        </div>
                        
                        <button class="btn btn--primary btn--full-width" onclick="completeWorkoutFirebase('${workout.id}')" style="margin-top: 16px;" id="completeWorkoutBtn">
                            Completa Allenamento
                        </button>
                    </div>
                </div>
                `;
                
            } catch (error) {
                console.error('Error loading current workout:', error);
                showError('Errore nel caricamento del workout: ' + error.message);
                container.innerHTML = `
                    <div class="card">
                        <div class="card__body">
                            <h3>Errore nel caricamento</h3>
                            <p>Impossibile caricare il workout. Riprova.</p>
                            <button class="btn btn--outline" onclick="loadCurrentWorkout()">Ricarica</button>
                        </div>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }
        
        function groupExercisesBySuperset(exercises) {
            const groups = [];
            const supersets = {};
            
            exercises.forEach((exercise, index) => {
                exercise.originalIndex = index;
                
                if (exercise.isSuperset) {
                    if (!supersets[exercise.supersetGroup]) {
                        supersets[exercise.supersetGroup] = {
                            isSuperset: true,
                            supersetGroup: exercise.supersetGroup,
                            exercises: [],
                            recoveryTime: 0
                        };
                        groups.push(supersets[exercise.supersetGroup]);
                    }
                    supersets[exercise.supersetGroup].exercises.push(exercise);
                    if (exercise.recoveryTime > 0) {
                        supersets[exercise.supersetGroup].recoveryTime = exercise.recoveryTime;
                    }
                } else {
                    groups.push({
                        isSuperset: false,
                        exercise: exercise
                    });
                }
            });
            
            return groups;
        }
        
        function renderExerciseCard(exercise, workoutId, exerciseIndex, showRecovery) {
            const repsArray = parseReps(exercise.reps);
            const isProgressive = repsArray.length > 1;
            
            return `
                <div class="exercise-card card" style="margin-bottom: ${showRecovery && exercise.recoveryTime > 0 ? '8px' : '16px'};">
                    <div class="card__body">
                        ${exercise.youtubeLink ? `<button class="youtube-btn" onclick="window.open('${exercise.youtubeLink}', '_blank')">‚ñ∂ YouTube</button>` : ''}
                        
                        <div class="muscle-group ${getMuscleGroupClass(exercise.muscleGroup)}">
                            ${exercise.muscleGroup}
                        </div>
                        
                        <h4>${exercise.name}</h4>
                        <p style="color: var(--color-text-secondary); margin: 8px 0;">
                            ${exercise.sets} serie √ó ${exercise.reps} ripetizioni
                            ${exercise.suggestedWeight > 0 ? ` ‚Ä¢ Peso suggerito: ${exercise.suggestedWeight}kg` : ''}
                        </p>
                        
                        ${isProgressive ? `
                            <div style="margin-top: 16px;">
                                <h5 style="margin-bottom: 12px;">Registra peso per ogni serie:</h5>
                                ${repsArray.map((reps, setIndex) => `
                                    <div class="set-row">
                                        <span style="min-width: 100px;">Set ${setIndex + 1} (${reps} reps):</span>
                                        <input type="number" class="form-control weight-input" 
                                               value="${exercise.actualWeights[setIndex] || ''}" 
                                               placeholder="kg" 
                                               step="0.5" 
                                               min="0"
                                               onchange="updateExerciseWeightForSet(${workoutId}, ${exerciseIndex}, ${setIndex}, this.value)">
                                        <span>kg</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="flex items-center gap-8" style="margin-top: 16px;">
                                <label class="form-label" style="margin: 0;">Peso utilizzato:</label>
                                <input type="number" class="form-control weight-input" 
                                       value="${exercise.actualWeights[0] || ''}" 
                                       placeholder="kg" 
                                       step="0.5" 
                                       min="0"
                                       onchange="updateExerciseWeightForSet(${workoutId}, ${exerciseIndex}, 0, this.value)">
                            </div>
                        `}
                    </div>
                </div>
                ${showRecovery && exercise.recoveryTime > 0 ? `
                    <div class="recovery-timer">
                        ‚è±Ô∏è Recupero: ${exercise.recoveryTime}s
                    </div>
                ` : ''}
            `;
        }

        // Store temporary workout data in memory during workout session
        let tempWorkoutData = {};
        
        function updateExerciseWeightForSet(workoutId, exerciseIndex, setIndex, weight) {
            if (!tempWorkoutData[workoutId]) {
                tempWorkoutData[workoutId] = {};
            }
            if (!tempWorkoutData[workoutId][exerciseIndex]) {
                tempWorkoutData[workoutId][exerciseIndex] = {};
            }
            tempWorkoutData[workoutId][exerciseIndex][setIndex] = weight ? parseFloat(weight) : null;
        }

        async function completeWorkoutFirebase(workoutId) {
            const completeButton = document.getElementById('completeWorkoutBtn');
            const originalText = completeButton.textContent;
            
            try {
                showLoading(true);
                completeButton.disabled = true;
                completeButton.textContent = '‚è≥ Completamento...';
                
                // Get workout data first
                const { data: workout, error: workoutError } = await supabaseClient
                    .from('workouts')
                    .select('*')
                    .eq('id', workoutId)
                    .single();
                
                if (workoutError || !workout) {
                    throw new Error('Workout non trovato');
                }
                
                // Collect all weights used from temp data
                const weightsUsed = workout.exercises.map((exercise, exerciseIndex) => {
                    const exerciseWeights = tempWorkoutData[workoutId] && tempWorkoutData[workoutId][exerciseIndex] || {};
                    return new Array(exercise.sets).fill(null).map((_, setIndex) => 
                        exerciseWeights[setIndex] || null
                    );
                });
                
                // Create completion record
                const completion = {
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
                    clientNote: currentWorkoutNote || '',
                    weightsUsed: weightsUsed
                };
                
                // Complete workout in Firebase
                const result = await completeWorkout(workoutId, completion);
                
                // Clear temp data and note
                delete tempWorkoutData[workoutId];
                currentWorkoutNote = '';
                
                // Show success message
                if (result.newStatus === 'expired') {
                    alert(`Congratulazioni! Hai completato tutto il programma ${workout.program_name}! (${result.newCompletions}/${result.totalCompletions})`);
                } else {
                    alert(`Workout completato! Progresso: ${result.newCompletions}/${result.totalCompletions}. Ottimo lavoro!`);
                }
                
                // Reload workout
                await loadCurrentWorkout();
                
            } catch (error) {
                console.error('Error completing workout:', error);
                showError('Errore durante il completamento: ' + error.message);
            } finally {
                showLoading(false);
                completeButton.disabled = false;
                completeButton.textContent = originalText;
            }
        }

        function showClientScreen(screen) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            if (screen === 'current') {
                showScreen('clientDashboard');
                event.target.closest('.nav-item').classList.add('active');
            } else if (screen === 'history') {
                showScreen('clientHistory');
                loadClientHistory();
                event.target.closest('.nav-item').classList.add('active');
            }
        }

        async function loadClientHistory() {
            const container = document.getElementById('historyList');
            
            try {
                showLoading(true);
                const clientWorkouts = await loadClientWorkouts(currentUser.uid);
                const workoutsWithHistory = clientWorkouts.filter(w => {
                    const history = w.completion_history || w.completionHistory || [];
                    return history.length > 0;
                });
            
                if (workoutsWithHistory.length === 0) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="card__body">
                                <h3>Nessuno storico disponibile</h3>
                                <p>Completa i tuoi primi workout per vedere lo storico qui.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
            
                // Flatten all completion history for chronological display
                const allCompletions = [];
                workoutsWithHistory.forEach(workout => {
                const completionHistory = workout.completion_history || workout.completionHistory || [];
                if (completionHistory && completionHistory.length > 0) {
                    completionHistory.forEach(completion => {
                        allCompletions.push({
                            ...completion,
                            programName: workout.program_name || workout.programName,
                            exercises: workout.exercises,
                            status: workout.status
                        });
                    });
                }
                });
                
                // Sort by date (newest first)
                allCompletions.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
            
                // Build history from all completions - FIXED: Always show program name
                container.innerHTML = allCompletions.map(completion => `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card__header">
                        <div class="flex justify-between items-center">
                            <h3>${completion.programName}</h3>
                            <div class="status status--success">
                                Completata
                            </div>
                        </div>
                        <p style="color: var(--color-text-secondary); margin: 8px 0 0 0;">Sessione del ${formatDate(completion.date)} alle ${completion.time}</p>
                    </div>
                    <div class="card__body">
                        ${completion.clientNote ? `
                            <div style="padding: 8px 12px; background: var(--color-bg-3); border-radius: var(--radius-sm); margin-bottom: 12px; font-style: italic;">
                                üí¨ "${completion.clientNote}"
                            </div>
                        ` : ''}
                        ${completion.exercises.map(exercise => {
                            const repsArray = parseReps(exercise.reps);
                            const isProgressive = repsArray.length > 1;
                            const hasWeights = exercise.actualWeights && exercise.actualWeights.some(w => w !== null);
                            
                            return `
                                <div style="padding: 12px 0; border-bottom: 1px solid var(--color-border);">
                                    <div class="flex justify-between items-start">
                                        <div style="flex: 1;">
                                            <div class="flex items-center gap-8 mb-8">
                                                <strong>${exercise.name}</strong>
                                                ${exercise.isSuperset ? `<span class="status status--info" style="font-size: 10px; padding: 2px 6px;">Superset ${exercise.supersetGroup}</span>` : ''}
                                            </div>
                                            <div class="muscle-group ${getMuscleGroupClass(exercise.muscleGroup)}" style="margin: 4px 0;">
                                                ${exercise.muscleGroup}
                                            </div>
                                            <small style="color: var(--color-text-secondary);">
                                                ${exercise.sets} serie √ó ${exercise.reps} ripetizioni
                                                ${exercise.recoveryTime > 0 ? ` ‚Ä¢ Recupero: ${exercise.recoveryTime}s` : ''}
                                            </small>
                                        </div>
                                        <div style="text-align: right; min-width: 120px;">
                                            ${hasWeights ? (
                                                isProgressive ? 
                                                `<div style="font-size: 12px;">
                                                    ${exercise.actualWeights.map((weight, index) => 
                                                        weight ? `Set ${index + 1}: <strong>${weight}kg</strong>` : `Set ${index + 1}: <span style="color: var(--color-text-secondary);">-</span>`
                                                    ).join('<br>')}
                                                </div>` :
                                                `<strong>${exercise.actualWeights[0]}kg</strong>`
                                            ) : '<span style="color: var(--color-text-secondary);">Peso non registrato</span>'}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Delete Workout Function with Firebase
        async function deleteWorkoutFirebase(workoutId) {
            try {
                // Get workout data first for confirmation
                const { data: workout, error: workoutError } = await supabaseClient
                    .from('workouts')
                    .select('*')
                    .eq('id', workoutId)
                    .single();
                
                if (workoutError || !workout) {
                    alert('Workout non trovato.');
                    return;
                }
                
                const completionCount = workout.completion_history ? workout.completion_history.length : 0;
                
                const confirmMessage = `Sei sicuro di voler eliminare "${workout.program_name}" di ${workout.client_name}?\n\nQuesta azione non pu√≤ essere annullata e rimuover√†:\n- Tutti gli esercizi della scheda\n- Lo storico dei completamenti (${completionCount} sessioni)\n- I progressi del cliente per questa scheda`;
                
                if (confirm(confirmMessage)) {
                    showLoading(true);
                    
                    // Delete from Firebase
                    await deleteWorkout(workoutId);
                    
                    // Show success message
                    alert(`‚úÖ Scheda "${workout.program_name}" eliminata con successo!\n\nLa scheda √® stata rimossa dal profilo di ${workout.client_name}.`);
                    
                    // Refresh the monitor view
                    await loadProgressMonitor();
                }
            } catch (error) {
                console.error('Error deleting workout:', error);
                showError('Errore durante l\'eliminazione: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // View Workout Details Function with Firebase
        async function viewWorkoutDetails(workoutId) {
            try {
                showLoading(true);
                
                const { data: workoutData, error: workoutError } = await supabaseClient
                    .from('workouts')
                    .select('*')
                    .eq('id', workoutId)
                    .single();
                
                if (workoutError || !workoutData) {
                    alert('Workout non trovato.');
                    return;
                }
                
                const workout = {
                    id: workoutData.id,
                    programName: workoutData.program_name,
                    clientId: workoutData.client_id,
                    currentCompletions: workoutData.current_completions,
                    totalCompletions: workoutData.total_completions,
                    exercises: workoutData.exercises,
                    completionHistory: workoutData.completion_history || [],
                    status: workoutData.status,
                    createdDate: workoutData.created_at
                };
                
                // Get client data
                const { data: client, error: clientError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', workout.clientId)
                    .single();
                
                const clientData = (clientError || !client) ? { name: 'Cliente rimosso' } : client;
            
            // Create modal with workout details
            const modalHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;" onclick="closeWorkoutDetails()">
                    <div class="card" style="width: 90%; max-width: 600px; margin: 20px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation();">
                        <div class="card__header">
                            <div class="flex justify-between items-center">
                                <h3>Dettagli ${workout.programName}</h3>
                                <button class="btn btn--outline btn--sm" onclick="closeWorkoutDetails()">‚úï Chiudi</button>
                            </div>
                            <p style="color: var(--color-text-secondary); margin: 8px 0 0 0;">Cliente: ${clientData.name} ‚Ä¢ Creata: ${formatDate(workout.createdDate)}</p>
                        </div>
                        <div class="card__body">
                            <div class="flex justify-between items-center" style="margin-bottom: 16px;">
                                <div class="status ${workout.status === 'active' ? 'status--success' : 'status--info'}">
                                    ${workout.status === 'active' ? 'Scheda Attiva' : 'Scheda Completata'}
                                </div>
                                <span style="font-size: 14px;">Progressi: ${workout.currentCompletions}/${workout.totalCompletions}</span>
                            </div>
                            
                            <h4 style="margin: 16px 0 12px 0;">Esercizi (${workout.exercises.length}):</h4>
                            ${workout.exercises.map((exercise, index) => `
                                <div style="padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-base); margin-bottom: 8px; background: ${exercise.isSuperset ? 'var(--color-bg-5)' : 'var(--color-surface)'};"> 
                                    <div class="flex justify-between items-start">
                                        <div style="flex: 1;">
                                            <div class="flex items-center gap-8">
                                                <strong>${exercise.name}</strong>
                                                ${exercise.isSuperset ? `<span class="status status--info" style="font-size: 10px; padding: 2px 6px;">Superset ${exercise.supersetGroup}</span>` : ''}
                                            </div>
                                            <div class="muscle-group ${getMuscleGroupClass(exercise.muscleGroup)}" style="margin: 4px 0;">
                                                ${exercise.muscleGroup}
                                            </div>
                                            <div style="font-size: 12px; color: var(--color-text-secondary);">
                                                ${exercise.sets} serie √ó ${exercise.reps} reps
                                                ${exercise.suggestedWeight > 0 ? ` ‚Ä¢ ${exercise.suggestedWeight}kg suggeriti` : ''}
                                                ${exercise.recoveryTime > 0 ? ` ‚Ä¢ ${exercise.recoveryTime}s recupero` : ''}
                                            </div>
                                            ${exercise.youtubeLink ? `<a href="${exercise.youtubeLink}" target="_blank" style="font-size: 11px; color: var(--color-primary);">üé• Video Tutorial</a>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${workout.completionHistory && workout.completionHistory.length > 0 ? `
                                <h4 style="margin: 24px 0 12px 0;">Storico Completamenti (${workout.completionHistory.length}):</h4>
                                ${workout.completionHistory.slice().reverse().map(completion => `
                                    <div style="padding: 12px; background: var(--color-bg-3); border-radius: var(--radius-base); margin-bottom: 8px;">
                                        <div class="flex justify-between items-center">
                                            <strong>${formatDate(completion.date)} - ${completion.time}</strong>
                                        </div>
                                        ${completion.clientNote ? `<div style="margin-top: 8px; font-style: italic; font-size: 14px;">"${completion.clientNote}"</div>` : ''}
                                        <div style="margin-top: 8px; font-size: 12px; color: var(--color-text-secondary);">Pesi utilizzati disponibili nei dati dettagliati</div>
                                    </div>
                                `).join('')}
                            ` : '<p style="color: var(--color-text-secondary);">Nessun completamento registrato.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading workout details:', error);
                showError('Errore nel caricamento dei dettagli: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function closeWorkoutDetails() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }
        
        // Real-time listeners (optional but recommended)
        function setupRealtimeListeners() {
            if (!currentUser || currentUser.role !== 'pt') return;
            
            // Listen to workouts changes for current PT
            db.collection('workouts')
                .where('clientId', 'in', [/* client IDs will be populated dynamically */])
                .onSnapshot((snapshot) => {
                    console.log('Workouts updated in real-time');
                    // Optionally refresh current view
                }, (error) => {
                    console.error('Error in workouts listener:', error);
                });
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('PT Workout Tracker with Supabase initialized');
            
            // Initialize program name dropdown when needed
            setTimeout(() => {
                const programSelect = document.getElementById('programName');
                if (programSelect) {
                    programSelect.innerHTML = '<option value="">Seleziona programma...</option>' +
                        programNames.map(name => `<option value="${name}">${name}</option>`).join('');
                }
            }, 100);
            
            console.log('Supabase client initialized successfully');
            console.log('Ready to create initial PT accounts via console:');
            console.log('Run: createInitialPT(\'giulia@pt.com\', \'Narbolia123\', \'Giulia\', \'Giulia_PT\')');
            console.log('Run: createInitialPT(\'fab@dev.com\', \'Tiferet456\', \'Fabio Dev\', \'Fab_dev\')');
        });
        
        // Error handling for uncaught Supabase errors
        window.addEventListener('unhandledrejection', (event) => {
            if (event.reason && event.reason.message && (event.reason.message.includes('supabase') || event.reason.message.includes('fetch'))) {
                console.error('Unhandled Supabase error:', event.reason);
                showError('Errore di connessione Supabase: ' + (event.reason.message || 'Errore sconosciuto'));
                event.preventDefault();
            }
        });
    </script>

<div popover="manual" style="z-index: 2147483647 !important; padding: 0px !important; margin: 0px !important; border-radius: 8px !important; position: fixed !important; color-scheme: normal !important; box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px 0px, rgba(0, 0, 0, 0.18) 0px 8px 15px 6px !important; border: 1px solid rgba(0, 0, 0, 0.2) !important; overflow: hidden !important; backdrop-filter: blur(20px) !important; background-color: rgba(230, 230, 230, 0.8) !important; top: 393px !important; left: -999999px !important; opacity: 0 !important; visibility: hidden !important;"><template shadowrootmode="open"><iframe src="chrome-extension://pejdijmoenmkgeppbflobdenhhabjlaj/completion_list.html?username=&amp;colorScheme=&amp;screenX=0&amp;screenY=0&amp;effectiveWindowWidth=1920&amp;isDark=false" frameborder="0" style="width: 9001px !important; height: 100% !important; display: block !important;"></iframe></template></div></body></html>